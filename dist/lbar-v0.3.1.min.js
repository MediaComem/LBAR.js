AFRAME.registerSystem("gps-position",{schema:{minAccuracy:{type:"int",default:100},minDistance:{type:"number",default:2},cam3DoF:{type:"boolean",default:!0}},init:function(){this.checkDependencies()&&(this.currentPosition={latitude:0,longitude:0},this.originPosition=null,this._onDeviceGPS=this._onDeviceGPS.bind(this),this._onDeviceGPSError=this._onDeviceGPSError.bind(this),this._watchPosition=navigator.geolocation.watchPosition(this._onDeviceGPS,this._onDeviceGPSError,{enableHighAccuracy:!0,timeout:2e4}),this.video=null,!this.data.cam3DoF||this.el.sceneEl.is("vr-mode")||this.el.sceneEl.is("ar-mode")||this._createVideo(),this._onEnterVrAr=this._onEnterVrAr.bind(this),this._onExitVrAr=this._onExitVrAr.bind(this),window.addEventListener("enter-vr",this._onEnterVrAr),window.addEventListener("exit-vr",this._onExitVrAr))},remove:function(){this._removeVideo(),window.removeEventListener("enter-vr",this._onEnterVrAr),window.removeEventListener("exit-vr",this._onExitVrAr),this._watchPosition&&navigator.geolocation.clearWatch(this._watchPosition)},update:function(t){0!==Object.entries(t).length&&this.data.cam3DoF!==t.cam3DoF&&(this.data.cam3DoF?this._createVideo():this._removeVideo())},checkDependencies:function(){let t=!0;return"geolocation"in navigator==!1&&(console.error("Geolocation is not supported by your browser"),t=!1),t},_onEnterVrAr:function(){this._pauseVideo()},_onExitVrAr:function(){this.video?this._unPauseVideo():this.data.cam3DoF&&this._createVideo()},_createVideo:function(){this.videoContainer=document.createElement("video-container"),this.videoContainer.style.width="100vw",this.videoContainer.style.height="100vh",this.videoContainer.style.position="absolute",this.videoContainer.style.top="0",this.videoContainer.style.left="0",this.videoContainer.style.zIndex="-2",this.video=document.createElement("video"),this.video.setAttribute("autoplay",""),this.video.setAttribute("muted",""),this.video.setAttribute("playsinline",""),this.video.style.height="100vh",navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}}).then(t=>this.video.srcObject=t):console.error("getUserMedia failed to get the Video stream"),this.videoContainer.appendChild(this.video),document.body.appendChild(this.videoContainer)},_removeVideo:function(){this.video&&(this._pauseVideo(),this.video.remove(),this.videoContainer.removeChild(this.video),this.video=null,document.body.removeChild(this.videoContainer),this.videoContainer=null)},_pauseVideo:function(){if(this.video){this.video.pause();const t=this.video.srcObject.getTracks();t.forEach(t=>t.stop())}},_unPauseVideo:function(){this.video&&(navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}}).then(t=>this.video.srcObject=t),this.video.play())},_onDeviceGPSError:function(t){1===t.code&&console.error("Please activate Geolocation and refresh the page. If it is already active, please check permissions for this website."),3===t.code&&console.error("Cannot retrieve GPS position. Signal is absent.")},_onDeviceGPS:function(t){t={latitude:t.coords.latitude,longitude:t.coords.longitude,altitude:t.coords.altitude,accuracy:t.coords.accuracy};t.accuracy>this.data.minAccuracy?console.error("GPS signal is very poor. Try move outdoor or to an area with a better signal."):(this._haversineDist(this.currentPosition,t)>=this.data.minDistance||!this.originPosition)&&(this.currentPosition=t,window.dispatchEvent(new CustomEvent("gps-position-update",{detail:{...this.currentPosition}})),this.originPosition||(this.originPosition=this.currentPosition,window.dispatchEvent(new CustomEvent("gps-position-set",{detail:{...this.currentPosition}}))))},_haversineDist:function(t,e){var i=THREE.MathUtils.degToRad(e.longitude-t.longitude),o=THREE.MathUtils.degToRad(e.latitude-t.latitude),o=Math.sin(o/2)*Math.sin(o/2)+Math.cos(THREE.MathUtils.degToRad(t.latitude))*Math.cos(THREE.MathUtils.degToRad(e.latitude))*(Math.sin(i/2)*Math.sin(i/2));return 6371e3*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}}),AFRAME.registerComponent("gps-position",{schema:{longitude:{type:"number",default:0},latitude:{type:"number",default:0}},init:function(){this._onPositionSet=this._onPositionSet.bind(this),this._onPositionUpdate=this._onPositionUpdate.bind(this),this.system.originPosition?this._onPositionUpdate({detail:this.system.currentPosition}):this.el.setAttribute("visible",!1),window.addEventListener("gps-position-set",this._onPositionSet),window.addEventListener("gps-position-update",this._onPositionUpdate),this._onExitVrAr=this._onExitVrAr.bind(this),window.addEventListener("exit-vr",this._onExitVrAr)},remove:function(){window.removeEventListener("gps-position-set",this._onPositionSet),window.removeEventListener("gps-position-update",this._onPositionUpdate),window.removeEventListener("exit-vr",this._onExitVrAr)},_onExitVrAr:function(){this._onPositionUpdate({detail:this.system.currentPosition})},_onPositionSet:function(t){this.el.setAttribute("visible",!0)},_onPositionUpdate:function(t){const e=this.system._haversineDist;t=t.detail;const i={x:0,y:this.el.getAttribute("position").y||0,z:0};i.x=e(t,{longitude:this.data.longitude,latitude:t.latitude}),i.x*=this.data.longitude>t.longitude?1:-1,i.z=e(t,{longitude:t.longitude,latitude:this.data.latitude}),i.z*=this.data.latitude>t.latitude?-1:1,this.el.setAttribute("position",i)}}),AFRAME.registerComponent("faces-north",{init:function(){this.checkDependencies()&&(this.alwaysInSynch=!this.el.sceneEl.is("vr-mode")&&!this.el.sceneEl.is("ar-mode"),this.heading=null,this._onDeviceOrientation=this._onDeviceOrientation.bind(this),window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._onEnterVrAr=this._onEnterVrAr.bind(this),this._onExitVrAr=this._onExitVrAr.bind(this),window.addEventListener("enter-vr",this._onEnterVrAr),window.addEventListener("exit-vr",this._onExitVrAr),this._onPositionUpdate=this._onPositionUpdate.bind(this),window.addEventListener("gps-position-update",this._onPositionUpdate))},checkDependencies:function(){let t=!0;return"ondeviceorientationabsolute"in window==!1&&(console.error("Compass absolute orientation not supported by your browser"),t=!1),t},remove:function(){window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),window.removeEventListener("gps-position-update",this._onPositionUpdate),window.removeEventListener("enter-vr",this._onEnterVrAr),window.removeEventListener("exit-vr",this._onExitVrAr)},_onEnterVrAr:function(){this.alwaysInSynch=!1},_onExitVrAr:function(){this.alwaysInSynch=!0,this.el.object3D.position.x=0,this.el.object3D.position.z=0},_onPositionUpdate:function(t){var e;(this.el.sceneEl.is("vr-mode")||this.el.sceneEl.is("ar-mode"))&&(e=this.el.sceneEl.camera.el.object3D.position,this.el.object3D.position.x=e.x,this.el.object3D.position.z=e.z)},_onDeviceOrientation:function(t){t.alpha?t.absolute?(t=this._computeCompassHeading(t.alpha,t.beta,t.gamma),this.alwaysInSynch||!this.heading?(this.heading=t,this._updateRotation()):this.heading=t):console.error("Not an absolute orientation event"):console.error("No alpha data in the Orientation event")},_updateRotation:function(){this.el.object3D.rotation.y=THREE.MathUtils.degToRad(this.heading%360)},_computeCompassHeading:function(t,e,i){var t=t*(Math.PI/180),e=e*(Math.PI/180),i=i*(Math.PI/180),o=Math.cos(t),t=Math.sin(t),e=Math.sin(e),n=Math.cos(i),i=Math.sin(i),s=-o*i-t*e*n,t=-t*i+o*e*n;let r=Math.atan(s/t);return t<0?r+=Math.PI:s<0&&(r+=2*Math.PI),r*=180/Math.PI}}),AFRAME.registerComponent("pitch-roll-look-controls",{dependencies:["position","rotation"],schema:{enabled:{default:!0},magicWindowTrackingEnabled:{default:!0},pointerLockEnabled:{default:!1},reverseMouseDrag:{default:!1},reverseTouchDrag:{default:!1},touchEnabled:{default:!0},mouseEnabled:{default:!0}},init:function(){this.deltaYaw=0,this.previousHMDPosition=new THREE.Vector3,this.hmdQuaternion=new THREE.Quaternion,this.magicWindowAbsoluteEuler=new THREE.Euler,this.magicWindowDeltaEuler=new THREE.Euler,this.position=new THREE.Vector3,this.magicWindowObject=new THREE.Object3D,this.rotation={},this.deltaRotation={},this.savedPose=null,this.pointerLocked=!1,this.setupMouseControls(),this.bindMethods(),this.previousMouseEvent={},this.setupMagicWindowControls(),this.savedPose={position:new THREE.Vector3,rotation:new THREE.Euler},(this.el.sceneEl.is("vr-mode")||this.el.sceneEl.is("ar-mode"))&&this.onEnterVR()},setupMagicWindowControls:function(){var t,e=this.data;(AFRAME.utils.device.isMobile()||AFRAME.utils.device.isMobileDeviceRequestingDesktopSite())&&(t=this.magicWindowControls=new THREE.DeviceOrientationControls(this.magicWindowObject),"undefined"!=typeof DeviceOrientationEvent&&DeviceOrientationEvent.requestPermission&&(t.enabled=!1,this.el.sceneEl.components["device-orientation-permission-ui"].permissionGranted?t.enabled=e.magicWindowTrackingEnabled:this.el.sceneEl.addEventListener("deviceorientationpermissiongranted",function(){t.enabled=e.magicWindowTrackingEnabled})))},update:function(t){var e=this.data;e.enabled!==t.enabled&&this.updateGrabCursor(e.enabled),t&&!e.magicWindowTrackingEnabled&&t.magicWindowTrackingEnabled&&(this.magicWindowAbsoluteEuler.set(0,0,0),this.magicWindowDeltaEuler.set(0,0,0)),this.magicWindowControls&&(this.magicWindowControls.enabled=e.magicWindowTrackingEnabled),t&&!e.pointerLockEnabled!==t.pointerLockEnabled&&(this.removeEventListeners(),this.addEventListeners(),this.pointerLocked&&this.exitPointerLock())},tick:function(t){this.data.enabled&&this.updateOrientation()},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.pointerLocked&&this.exitPointerLock()},remove:function(){this.removeEventListeners(),this.pointerLocked&&this.exitPointerLock()},bindMethods:function(){this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onTouchStart=this.onTouchStart.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onEnterVR=this.onEnterVR.bind(this),this.onExitVR=this.onExitVR.bind(this),this.onPointerLockChange=this.onPointerLockChange.bind(this),this.onPointerLockError=this.onPointerLockError.bind(this)},setupMouseControls:function(){this.mouseDown=!1,this.pitchObject=new THREE.Object3D,this.yawObject=new THREE.Object3D,this.yawObject.position.y=10,this.yawObject.add(this.pitchObject)},addEventListeners:function(){var t=this.el.sceneEl,e=t.canvas;e?(e.addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("mousemove",this.onMouseMove,!1),window.addEventListener("mouseup",this.onMouseUp,!1),e.addEventListener("touchstart",this.onTouchStart),window.addEventListener("touchmove",this.onTouchMove),window.addEventListener("touchend",this.onTouchEnd),t.addEventListener("enter-vr",this.onEnterVR),t.addEventListener("exit-vr",this.onExitVR),this.data.pointerLockEnabled&&(document.addEventListener("pointerlockchange",this.onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",this.onPointerLockChange,!1),document.addEventListener("pointerlockerror",this.onPointerLockError,!1))):t.addEventListener("render-target-loaded",bind(this.addEventListeners,this))},removeEventListeners:function(){var t=this.el.sceneEl,e=t&&t.canvas;e&&(e.removeEventListener("mousedown",this.onMouseDown),window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp),e.removeEventListener("touchstart",this.onTouchStart),window.removeEventListener("touchmove",this.onTouchMove),window.removeEventListener("touchend",this.onTouchEnd),t.removeEventListener("enter-vr",this.onEnterVR),t.removeEventListener("exit-vr",this.onExitVR),document.removeEventListener("pointerlockchange",this.onPointerLockChange,!1),document.removeEventListener("mozpointerlockchange",this.onPointerLockChange,!1),document.removeEventListener("pointerlockerror",this.onPointerLockError,!1))},updateOrientation:function(){var t=this.el.object3D,e=this.pitchObject,i=(this.yawObject,this.el.sceneEl);(i.is("vr-mode")||i.is("ar-mode"))&&i.checkHeadsetConnected()||(this.updateMagicWindowOrientation(),t.rotation.x=this.magicWindowDeltaEuler.x+e.rotation.x,t.rotation.z=this.magicWindowDeltaEuler.z)},updateMagicWindowOrientation:function(){var t=this.magicWindowAbsoluteEuler,e=this.magicWindowDeltaEuler;this.magicWindowControls&&this.magicWindowControls.enabled&&(this.magicWindowControls.update(),t.setFromQuaternion(this.magicWindowObject.quaternion,"YXZ"),this.previousMagicWindowYaw||0===t.y||(this.previousMagicWindowYaw=t.y),this.previousMagicWindowYaw&&(e.x=t.x,e.y+=t.y-this.previousMagicWindowYaw,e.z=t.z,this.previousMagicWindowYaw=t.y))},onMouseMove:function(t){var e,i=this.pitchObject,o=this.previousMouseEvent,n=this.yawObject;this.data.enabled&&(this.mouseDown||this.pointerLocked)&&(o=this.pointerLocked?(e=t.movementX||t.mozMovementX||0,t.movementY||t.mozMovementY||0):(e=t.screenX-o.screenX,t.screenY-o.screenY),this.previousMouseEvent.screenX=t.screenX,this.previousMouseEvent.screenY=t.screenY,t=this.data.reverseMouseDrag?1:-1,n.rotation.y+=.002*e*t,i.rotation.x+=.002*o*t,i.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,i.rotation.x)))},onMouseDown:function(t){var e=this.el.sceneEl;!this.data.enabled||!this.data.mouseEnabled||(e.is("vr-mode")||e.is("ar-mode"))&&e.checkHeadsetConnected()||0===t.button&&(e=e&&e.canvas,this.mouseDown=!0,this.previousMouseEvent.screenX=t.screenX,this.previousMouseEvent.screenY=t.screenY,this.showGrabbingCursor(),this.data.pointerLockEnabled&&!this.pointerLocked&&(e.requestPointerLock?e.requestPointerLock():e.mozRequestPointerLock&&e.mozRequestPointerLock()))},showGrabbingCursor:function(){this.el.sceneEl.canvas.style.cursor="grabbing"},hideGrabbingCursor:function(){this.el.sceneEl.canvas.style.cursor=""},onMouseUp:function(){this.mouseDown=!1,this.hideGrabbingCursor()},onTouchStart:function(t){1!==t.touches.length||!this.data.touchEnabled||this.el.sceneEl.is("vr-mode")||this.el.sceneEl.is("ar-mode")||(this.touchStart={x:t.touches[0].pageX,y:t.touches[0].pageY},this.touchStarted=!0)},onTouchMove:function(t){var e,i=this.el.sceneEl.canvas,o=this.yawObject;this.touchStarted&&this.data.touchEnabled&&(i=2*Math.PI*(t.touches[0].pageX-this.touchStart.x)/i.clientWidth,e=this.data.reverseTouchDrag?1:-1,o.rotation.y-=.5*i*e,this.touchStart={x:t.touches[0].pageX,y:t.touches[0].pageY})},onTouchEnd:function(){this.touchStarted=!1},onEnterVR:function(){var t=this.el.sceneEl;t.checkHeadsetConnected()&&(this.saveCameraPose(),this.el.object3D.position.set(0,0,0),this.el.object3D.rotation.set(0,0,0),t.hasWebXR&&(this.el.object3D.matrixAutoUpdate=!1,this.el.object3D.updateMatrix()))},onExitVR:function(){this.el.sceneEl.checkHeadsetConnected()&&(this.restoreCameraPose(),this.previousHMDPosition.set(0,0,0),this.el.object3D.matrixAutoUpdate=!0)},onPointerLockChange:function(){this.pointerLocked=!(!document.pointerLockElement&&!document.mozPointerLockElement)},onPointerLockError:function(){this.pointerLocked=!1},exitPointerLock:function(){document.exitPointerLock(),this.pointerLocked=!1},updateGrabCursor:function(t){var e=this.el.sceneEl;function i(){e.canvas.classList.add("a-grab-cursor")}function o(){e.canvas.classList.remove("a-grab-cursor")}e.canvas?(t?i:o)():t?e.addEventListener("render-target-loaded",i):e.addEventListener("render-target-loaded",o)},saveCameraPose:function(){var t=this.el;this.savedPose.position.copy(t.object3D.position),this.savedPose.rotation.copy(t.object3D.rotation),this.hasSavedPose=!0},restoreCameraPose:function(){var t=this.el,e=this.savedPose;this.hasSavedPose&&(t.object3D.position.copy(e.position),t.object3D.rotation.copy(e.rotation),this.hasSavedPose=!1)}});